name: $(Rev:r) # build numbering format

resources:
- repo: self
queue:
  name: Hosted VS2017
  demands: npm

steps:
- task: Npm@1
  displayName: 'NPM CI'
  inputs:
    command: custom
    verbose: false
    customCommand: ci
    
# - task: Npm@1
#   displayName: 'Git Clean'
#   inputs:
#     command: custom
#     verbose: false
#     customCommand: 'run ci-git-clean'

# - task: Npm@1
#   displayName: 'Git Config'
#   inputs:
#     command: custom
#     verbose: false
#     customCommand: 'run ci-git-config'

- powershell: |
   $filePath= Join-Path -Path $(Build.Repository.LocalPath) -ChildPath "package.json"
   
   Write-Host "Repository LocalPath: $(Build.Repository.LocalPath)"
   Write-Host "Environment-File: $filePath"
   Write-Host "Build Number: $(Build.BuildNumber)"
   $environmentContent = Get-Content $filePath
   $replaced = $environmentContent -replace '__BuildVersion__', '$(Build.BuildNumber)'
   Set-Content -Path $filePath -value $replaced
  displayName: 'Update Version - NPM'

- powershell: |
   $filePath= Join-Path -Path $(Build.Repository.LocalPath) -ChildPath "\NugetVulnerabilityScanTask\task.json"
   
   Write-Host "Repository LocalPath: $(Build.Repository.LocalPath)"
   Write-Host "Environment-File: $filePath"
   Write-Host "Build Number: $(Build.BuildNumber)"
   $environmentContent = Get-Content $filePath
   $replaced = $environmentContent -replace '__BuildVersion__', '$(Build.BuildNumber)'
   Set-Content -Path $filePath -value $replaced
  displayName: 'Update Version - Task'

- task: Npm@1
  displayName: 'Build Prod'
  inputs:
    command: custom
    verbose: false
    customCommand: 'run ci-build'

# - task: Npm@1
#   displayName: 'Update version'
#   inputs:
#     command: custom
#     verbose: false
#     customCommand: 'version $(Build.BuildNumber)'

- task: Npm@1
  displayName: 'Build'
  inputs:
    command: custom
    verbose: false
    customCommand: 'run ci-build'

- task: Npm@1
  displayName: 'Publish'
  inputs:
    command: custom
    verbose: false
    customCommand: 'run ci-vsce-publish -- -p $(AzureDevOpsPublishToken)'

